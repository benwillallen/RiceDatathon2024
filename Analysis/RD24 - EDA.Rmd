---
title: "RD24 - EDA"
author: "Benjamin Allen"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(mice)
knitr::opts_chunk$set(echo = TRUE)
```

## Importing Data

```{r}
oil_data <- read_csv("../Data/training.csv")

# Remove rows where response is missing
oil_data <- oil_data %>% 
  filter(!is.na(OilPeakRate))
```

## Missing Data

```{r}
na_count <- as.data.frame(sapply(oil_data, function(y) sum(is.na(y))))
colnames(na_count) <- c("NA_Count")

# Counts
ggplot(data=na_count, mapping=aes(x=rownames(na_count), y=NA_Count)) +
  geom_bar(stat="identity") + theme(axis.text.x=element_text(angle=90))

# Percentages
ggplot(data=na_count, mapping=aes(x=rownames(na_count), y=NA_Count/nrow(oil_data), fill=NA_Count/nrow(oil_data))) +
  geom_bar(stat="identity") +
  scale_y_continuous(labels=seq(0, 1, 0.1), breaks=seq(0, 1, 0.1)) +
  scale_fill_binned(name="% of Rows Missing", breaks=seq(0, 1, 0.2), type="viridis") +
  labs(title="Percent of Data Missing by Column", x="", y="% of Rows Missing") +
  theme_bw() + theme(axis.text.x=element_text(angle=90))
ggsave("./Visuals/missing_percent_chart.png")
```

The variables `average_frac_fluid_per_stage`, `average_proppant_per_stage`, `average_stage_length`, and `number_of_stages` are all missing well over 80% of their data, and can likely be removed without harming predictive capabilities. The remaining columns have few enough missing values that it is reasonable to impute them.

```{r}
md.pattern(oil_data)
```

## Continuous Distributions

```{r}
summary(oil_data)
```

## Categorical Distributions

```{r}
table(oil_data$ffs_frac_type)
table(oil_data$relative_well_position)
table(oil_data$batch_frac_classification)
table(oil_data$well_family_relationship)
table(oil_data$frac_type)
```

Based on this we can also remove the `frac_type` variable as it is the same for all rows.

## Relationships with Response

```{r}
ggplot(data=oil_data, mapping=aes(x=ffs_frac_type, y=OilPeakRate, fill=ffs_frac_type)) +
  geom_violin()
ggsave("./Visuals/ffs_frac_type_violinplot.png")

test <- oil_data %>% 
  filter(!is.na(frac_fluid_to_proppant_ratio) & !is.na(proppant_to_frac_fluid_ratio)) %>% 
  mutate(frac_fluid_to_proppant_ratio = 1/frac_fluid_to_proppant_ratio)

cor(test$frac_fluid_to_proppant_ratio, test$proppant_to_frac_fluid_ratio)
```

```{r}
ggplot(data=oil_data, mapping=aes(x=surface_x, y=surface_y, color=standardized_operator_name)) +
  geom_point() + scale_color_distiller(palette = "Spectral") + scale_color_distiller(palette = "Spectral")

ggplot(data=oil_data, mapping=aes(x=surface_x, y=surface_y, color=ifelse(OilPeakRate>1000,"Yes", "No"),
                                  alpha=ifelse(OilPeakRate>1000, 1, 0.01), size=ifelse(OilPeakRate>1000, 0.06, 0.05))) +
  geom_point()
```

## Outlier Charts 

```{r}
ggplot(oil_data, mapping=aes(x=total_proppant, y=OilPeakRate, color=total_proppant, size=total_proppant)) +
  geom_point() + theme_dark() + scale_color_gradient(name="Total Proppant", low="royalblue4", high="red") +
  scale_size(name="Total Proppant") + theme(plot.background = element_rect(fill = "#211A1E", color="#211A1E"),
        panel.background = element_rect(fill = "#291f25"),
        legend.background = element_rect(fill = "#211A1E"),
        legend.key.height = unit(0.5, "cm"),
        text = element_text(family="Bahnschrift", color="#fff0d5", size=16),
        plot.title = element_text(size=30),
        strip.text = element_text(color="#fff0d5", size=16),
        plot.margin = margin(25, 25, 25, 25)) +
  labs(x="Total Proppant", y="Oil Peak Rate")
ggsave("../Analysis/Visuals/outlier_proppant.png", width=1920, height=1080, units="px")
```

```{r}
ggplot(oil_data, mapping=aes(x=total_fluid, y=OilPeakRate, color=total_fluid, size=total_proppant)) +
  geom_point() + theme_dark() + scale_color_gradient(name="Total Fluid", low="royalblue4", high="red") +
  scale_size(name="Total Fluid") + theme(plot.background = element_rect(fill = "#211A1E", color="#211A1E"),
        panel.background = element_rect(fill = "#291f25"),
        legend.background = element_rect(fill = "#211A1E"),
        legend.key.height = unit(0.5, "cm"),
        text = element_text(family="Bahnschrift", color="#fff0d5", size=16),
        plot.title = element_text(size=30),
        strip.text = element_text(color="#fff0d5", size=16),
        plot.margin = margin(25, 25, 25, 25)) +
  labs(x="Total Fluid", y="Oil Peak Rate")
ggsave("../Analysis/Visuals/outlier_fluid.png", width=1920, height=1080, units="px")
```

```{r}
ggplot(oil_data, mapping=aes(x=surface_x, y=surface_y, color=OilPeakRate)) +
  geom_point(alpha=0.5) + theme_dark() + scale_color_distiller(palette="Spectral") +
  scale_size(name="Total Fluid") + theme(plot.background = element_rect(fill = "#211A1E", color="#211A1E"),
        panel.background = element_rect(fill = "#291f25"),
        legend.background = element_rect(fill = "#211A1E"),
        legend.key.height = unit(0.5, "cm"),
        text = element_text(family="Bahnschrift", color="#fff0d5", size=16),
        plot.title = element_text(size=30),
        strip.text = element_text(color="#fff0d5", size=16)) +
  labs(x="X", y="Y", title="Oil Peak Rate by Location")
ggsave("../Analysis/Visuals/oil_by_location.png", width=1920, height=1080, units="px")
```

